<?php
session_start();
if (!isset($_SESSION['username'])) {
    header("Location: index.php");
    exit;
}

require 'vendor/autoload.php';
require_once 'database_connection.php';
use PhpOffice\PhpSpreadsheet\IOFactory;

$db = new Database();
$conn = $db->getConnection();

// AJAX: Preview Excel
if(isset($_POST['action']) && $_POST['action']==='preview' && isset($_FILES['file'])){
    $file = $_FILES['file'];
    $ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
    if(!in_array($ext,['csv','xls','xlsx'])) exit("<div class='alert alert-danger'>Only CSV/XLS/XLSX allowed.</div>");

    $uploadDir = 'uploads/';
    if(!is_dir($uploadDir)) mkdir($uploadDir, 0777, true);
    $filePath = $uploadDir.basename($file['name']);
    move_uploaded_file($file['tmp_name'], $filePath);

    $spreadsheet = IOFactory::load($filePath);
    $sheet = $spreadsheet->getActiveSheet();

    $rows = [];
    $header = [];
    foreach($sheet->getRowIterator() as $rowIndex => $row){
        $cellIterator = $row->getCellIterator();
        $cellIterator->setIterateOnlyExistingCells(false);
        $data = [];
        foreach($cellIterator as $cell) $data[] = $cell->getValue();
        if($rowIndex == 1){
            $header = $data; // First row = headers
        } else {
            $rows[] = array_combine($header, $data);
        }
    }

    if(count($rows)==0) exit("<div class='alert alert-warning'>No data found</div>");

    // Remove duplicates by email automatically (file duplicates)
    $uniqueRows = [];
    $emailSet = [];
    foreach($rows as $row){
        $email = strtolower($row['email'] ?? '');
        if($email && !in_array($email,$emailSet)){
            $emailSet[] = $email;
            $uniqueRows[] = $row;
        }
    }

    echo "<form id='editForm'>";
    echo "<table id='previewTable' class='table table-bordered table-striped'>";
    echo "<thead><tr><th>#</th>";
    foreach($header as $col) echo "<th>$col</th>";
    echo "</tr></thead><tbody>";

    $i=1;
    foreach($uniqueRows as $row){
        echo "<tr data-row='$i'>";
        echo "<td>$i</td>";
        foreach($header as $col){
            $value = $row[$col] ?? '';
            // Make editable
            echo "<td contenteditable='true' data-column='$col'>".htmlspecialchars($value,ENT_QUOTES)."</td>";
        }
        echo "</tr>";
        $i++;
    }

    echo "</tbody></table>";
    echo "<button type='button' id='saveAll' class='btn btn-success mt-2'>Save All Changes</button>";
    echo "</form>";
    exit;
}

// AJAX: Save single cell
if(isset($_POST['action']) && $_POST['action']==='saveCell'){
    $rowIndex = intval($_POST['rowIndex']);
    $column = $_POST['column'];
    $value = $_POST['value'];
    $email = $_POST['email'] ?? '';

    // Update database if email exists
    if($email){
        $stmt = $conn->prepare("UPDATE staff SET `$column`=? WHERE email=?");
        $stmt->bind_param('ss',$value,$email);
        $stmt->execute();
        $stmt->close();
    }

    echo 'success';
    exit;
}

// AJAX: Save all
if(isset($_POST['action']) && $_POST['action']==='saveAll' && isset($_POST['data'])){
    $inserted = 0;
    foreach($_POST['data'] as $row){
        $columns = array_keys($row);
        $placeholders = implode(',', array_fill(0, count($columns), '?'));
        $cols = implode(',', $columns);

        // Skip duplicates in database
        if(isset($row['email'])){
            $check = $conn->prepare("SELECT COUNT(*) FROM staff WHERE email=?");
            $check->bind_param('s', $row['email']);
            $check->execute();
            $check->bind_result($count);
            $check->fetch();
            $check->close();
            if($count>0) continue;
        }

        $stmt = $conn->prepare("INSERT INTO staff($cols) VALUES($placeholders)");
        $types = str_repeat('s', count($row));
        $stmt->bind_param($types, ...array_values($row));
        if($stmt->execute()) $inserted++;
        $stmt->close();
    }

    echo "<div class='alert alert-success'>$inserted rows inserted successfully</div>";
    exit;
}
?>

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>staff</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<style>
body { padding:20px; background:#f8f9fa; }
#dropArea { border:2px dashed #007bff; border-radius:5px; padding:40px; text-align:center; color:#007bff; cursor:pointer;}
#dropArea.dragover { background-color:#e9ecef; }
.duplicate { background-color:#f8d7da; }
td[contenteditable] { background-color:#fff3cd; }
</style>
</head>
<body>
<div class="container">
    
    <p>Drag & Drop Staff file here or click to select</p>

    <div id="dropArea">Drop file here or click to browse</div>
    <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" style="display:none">
    <div id="previewContainer"></div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');

dropArea.addEventListener('click',()=>fileInput.click());
dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); });
dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.classList.remove('dragover'); fileInput.files=e.dataTransfer.files; previewFile(); });
fileInput.addEventListener('change', previewFile);

function previewFile(){
    let file = fileInput.files[0];
    if(!file) return;
    let formData = new FormData();
    formData.append('file', file);
    formData.append('action','preview');

    $.ajax({
        url: '',
        type: 'POST',
        data: formData,
        contentType:false,
        processData:false,
        success: function(response){
            $('#previewContainer').html(response);
            $('#previewTable').DataTable({paging:true,searching:true,ordering:true,pageLength:10});

            // Autosave on edit
            $('#previewTable').on('blur','td[contenteditable]', function(){
                let cell = $(this);
                let rowIndex = cell.closest('tr').data('row');
                let column = cell.data('column');
                let value = cell.text();
                let email = cell.closest('tr').find('td').eq(1).text(); // assuming email is column 2
                $.post('', {action:'saveCell', rowIndex:rowIndex, column:column, value:value, email:email});
            });

            $('#saveAll').on('click', function(){
                let data = [];
                $('#previewTable tbody tr').each(function(){
                    let rowData = {};
                    $(this).find('td[contenteditable]').each(function(){
                        let col = $(this).data('column');
                        rowData[col] = $(this).text();
                    });
                    data.push(rowData);
                });
                $.post('', {action:'saveAll', data:data}, function(res){
                    $('#previewContainer').html(res);
                });
            });
        }
    });
}
</script>
</body>
</html>